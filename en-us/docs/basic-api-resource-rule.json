{
  "filename": "basic-api-resource-rule.md",
  "__html": "<h1>How to use - resource and rule</h1>\n<h2>Introduction</h2>\n<p>To use Sentinel, you only need to complete 2 steps:</p>\n<ol>\n<li>Define resources</li>\n<li>Configure rules</li>\n</ol>\n<p>These two steps don’t have to be synchronized. As long as the resources are defined, you can add rules as needed. Multiple rules can be applied to the same resource simultaneously.</p>\n<p>Sentinel provides <a href=\"https://github.com/alibaba/Sentinel/wiki/Adapters-to-Popular-Framework\">integrations with popular open-source frameworks and libraries</a> as well (e.g. Spring Cloud, gRPC, Dubbo). After introducing these integrations, services and methods provided by these frameworks are defined as resources by default.</p>\n<h2>Define Resource</h2>\n<p>You can use one of the following approaches to define resources.</p>\n<h3>&quot;try&quot; and &quot;catch&quot; mode</h3>\n<pre><code class=\"language-java\">Entry entry = <span class=\"hljs-keyword\">null</span>;\n<span class=\"hljs-keyword\">try</span> {\n    entry = SphU.entry(resourceName);\n\n    <span class=\"hljs-comment\">// Your business logic here.</span>\n} <span class=\"hljs-keyword\">catch</span> (BlockException ex) {\n    <span class=\"hljs-comment\">// Resource is rejected.</span>\n\n    <span class=\"hljs-comment\">// Here to handle the block exception</span>\n} <span class=\"hljs-keyword\">finally</span> {\n    <span class=\"hljs-comment\">// DO NOT forget to exit the entry!</span>\n    <span class=\"hljs-keyword\">if</span> (entry != <span class=\"hljs-keyword\">null</span>) {\n        entry.exit();\n    }\n}\n</code></pre>\n<h3>Bool mode</h3>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">if</span> (SphO.entry(resourceName)) {\n  <span class=\"hljs-keyword\">try</span> {\n     <span class=\"hljs-comment\">// Your code logic here.</span>\n  } <span class=\"hljs-keyword\">finally</span> {\n      SphO.exit();\n  }\n} <span class=\"hljs-keyword\">else</span> {\n    <span class=\"hljs-comment\">// Resource is rejected.</span>\n    <span class=\"hljs-comment\">// Your logic to handle blocking here.</span>\n  }\n}\n</code></pre>\n<h3>Annotation mode</h3>\n<p>Sentinel supports defining resource with <code>@SentinelResource</code> annotation. See <a href=\"https://github.com/alibaba/Sentinel/blob/master/sentinel-extension/sentinel-annotation-aspectj/README.md\">annotation support</a> for guidelines.</p>\n<h3>Check block exception</h3>\n<p>You can check whether an exception is caused by Sentinel's flow control (<code>BlockException</code>) via:</p>\n<pre><code class=\"language-java\">BlockException.isBlockException(Throwable t);\n</code></pre>\n<h3>Integrations with open-source frameworks</h3>\n<p>For details, please refer to <a href=\"https://github.com/alibaba/Sentinel/wiki/Adapters-to-Popular-Framework\">Adapters to popular frameworks</a>.</p>\n<h3>Resource for asynchronous entries</h3>\n<p>Here is a simple example:</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">try</span> {\n    AsyncEntry entry = SphU.asyncEntry(resourceName);\n\n    <span class=\"hljs-comment\">// Asynchronous invocation.</span>\n    doAsync(userId, result -&gt; {\n        <span class=\"hljs-keyword\">try</span> {\n            <span class=\"hljs-comment\">// Handle your asynchronous result here.</span>\n        } <span class=\"hljs-keyword\">finally</span> {\n            <span class=\"hljs-comment\">// Exit after callback completed.</span>\n            entry.exit();\n        }\n    });\n} <span class=\"hljs-keyword\">catch</span> (BlockException ex) {\n    <span class=\"hljs-comment\">// Request blocked.</span>\n    <span class=\"hljs-comment\">// Handle the exception (e.g. retry or fallback).</span>\n}\n</code></pre>\n<p>For more advanced usage, you can refer to <a href=\"https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-basic/src/main/java/com/alibaba/csp/sentinel/demo/AsyncEntryDemo.java\">AsyncEntryDemo</a>.</p>\n<h2>Configure Rules</h2>\n<p>Sentinel provides APIs for you to modify your rules, which can be integrated with various kinds of rule repository, such as configuration server and NoSQL.</p>\n<h3>Definition of Rules</h3>\n<p>There are 4 types of rules：<strong>flow control rules</strong>, <strong>degrade rules</strong>, <strong>system protection rules</strong> and <strong>authority rules</strong>.</p>\n<h4>Flow control rules (FlowRule)</h4>\n<p><strong>Definition</strong></p>\n<p>key fields：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">Field</th>\n<th style=\"text-align:left\">Description</th>\n<th style=\"text-align:left\">Default value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">resource</td>\n<td style=\"text-align:left\">resource name</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">count</td>\n<td style=\"text-align:left\">threshold</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">grade</td>\n<td style=\"text-align:left\">flow control metric (QPS or concurrent thread count)</td>\n<td style=\"text-align:left\">QPS</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">limitApp</td>\n<td style=\"text-align:left\">refer to specified caller</td>\n<td style=\"text-align:left\">default</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">strategy</td>\n<td style=\"text-align:left\">by resource itself or other resource (<code>refResource</code>)，or entry (refResource)</td>\n<td style=\"text-align:left\">resource itself</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">controlBehavior</td>\n<td style=\"text-align:left\">traffic shaping control behavior (reject directly，queue，slow start up)</td>\n<td style=\"text-align:left\">reject directly</td>\n</tr>\n</tbody>\n</table>\n<p>Multiple rules can be applied to the same resource.</p>\n<p><strong>API</strong></p>\n<p><code>FlowRuleManager.loadRules()</code> can be used to configure flow control rules.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">initFlowQpsRule</span><span class=\"hljs-params\">()</span> </span>{\n        List&lt;FlowRule&gt; rules = <span class=\"hljs-keyword\">new</span> ArrayList&lt;FlowRule&gt;();\n        FlowRule rule1 = <span class=\"hljs-keyword\">new</span> FlowRule();\n        rule1.setResource(KEY);\n        <span class=\"hljs-comment\">// set limit qps to 20</span>\n        rule1.setCount(<span class=\"hljs-number\">20</span>);\n        rule1.setGrade(RuleConstant.FLOW_GRADE_QPS);\n        rule1.setLimitApp(<span class=\"hljs-string\">\"default\"</span>);\n        rules.add(rule1);\n        FlowRuleManager.loadRules(rules);\n}\n</code></pre>\n<p>For more details please refer to <a href=\"./flow-control.md\">Flow Control</a>.</p>\n<h4>Circuit breaking rules (DegradeRule)</h4>\n<p>Key fields:</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">Field</th>\n<th style=\"text-align:left\">Description</th>\n<th style=\"text-align:left\">Default value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">resource</td>\n<td style=\"text-align:left\">resource name</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">count</td>\n<td style=\"text-align:left\">threshold</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">grade</td>\n<td style=\"text-align:left\">circuit breaking mode, by response time or exception ratio</td>\n<td style=\"text-align:left\">response time</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">timeWindow</td>\n<td style=\"text-align:left\">degrade time window (in second)</td>\n<td style=\"text-align:left\"></td>\n</tr>\n</tbody>\n</table>\n<p>Multiple rules can be applied to the same resource.</p>\n<p><strong>API</strong></p>\n<p><code>DegradeRuleManager.loadRules()</code> can be used to configure degrade rules.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">initDegradeRule</span><span class=\"hljs-params\">()</span> </span>{\n        List&lt;DegradeRule&gt; rules = <span class=\"hljs-keyword\">new</span> ArrayList&lt;DegradeRule&gt;();\n        DegradeRule rule = <span class=\"hljs-keyword\">new</span> DegradeRule();\n        rule.setResource(KEY);\n        <span class=\"hljs-comment\">// set threshold rt, 10 ms</span>\n        rule.setCount(<span class=\"hljs-number\">10</span>);\n        rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);\n        rule.setTimeWindow(<span class=\"hljs-number\">10</span>);\n        rules.add(rule);\n        DegradeRuleManager.loadRules(rules);\n}\n</code></pre>\n<p>For more details, please refer to <a href=\"./circuit-breaking.md\">Circuit Breaking</a>.</p>\n<h4>System protection rules (SystemRule)</h4>\n<p>Key factors</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">Field</th>\n<th style=\"text-align:left\">Description</th>\n<th style=\"text-align:left\">Default value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">highestSystemLoad</td>\n<td style=\"text-align:left\">threshold of Load1</td>\n<td style=\"text-align:left\">-1(not valid)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">avgRt</td>\n<td style=\"text-align:left\">average response time</td>\n<td style=\"text-align:left\">-1(not valid)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">maxThread</td>\n<td style=\"text-align:left\">concurrent thread count</td>\n<td style=\"text-align:left\">-1(not valid)</td>\n</tr>\n</tbody>\n</table>\n<p><strong>API</strong></p>\n<p><code>SystemRuleManager.loadRules()</code> can be used to configure system protection rules.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">initSystemProtectionRule</span><span class=\"hljs-params\">()</span> </span>{\n  List&lt;SystemRule&gt; rules = <span class=\"hljs-keyword\">new</span> ArrayList&lt;&gt;();\n  SystemRule rule = <span class=\"hljs-keyword\">new</span> SystemRule();\n  rule.setHighestSystemLoad(<span class=\"hljs-number\">10</span>);\n  rules.add(rule);\n  SystemRuleManager.loadRules(rules);\n}\n</code></pre>\n<p>For more details, please refer to <a href=\"./system-adaptive-protection.md\">System Adaptive Protection</a>.</p>\n<h3>HTTP commands for rules</h3>\n<p>You can also use HTTP API to configure, query and update Sentinel rules.</p>\n<p>To use these API, make sure that the following library has been introduced:</p>\n<pre><code class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.csp<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>sentinel-transport-simple-http<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>x.y.z<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n</code></pre>\n<h4>Query command</h4>\n<p>API:</p>\n<pre><code class=\"language-shell\">curl http://localhost:8719/getRules?type=&lt;XXXX&gt;\n</code></pre>\n<ul>\n<li><code>type=flow</code> for flow rules;</li>\n<li><code>type=degrade</code> for circuit breaking rules;</li>\n<li><code>type=system</code> for system protection rules.</li>\n</ul>\n<p>Rules will be returned in JSON format.</p>\n<h4>Modification command</h4>\n<blockquote>\n<p>Note: Only for test, do not use in production.</p>\n</blockquote>\n<pre><code class=\"language-shell\">curl http://localhost:8719/setRules?type=&lt;XXXX&gt;&amp;data=&lt;DATA&gt;\n</code></pre>\n<h2>Integrate with rule repositories</h2>\n<p><a href=\"https://github.com/alibaba/Sentinel/blob/master/sentinel-extension/src/main/java/com/alibaba/csp/sentinel/datasource/AbstractDataSource.java\">DataSource</a> is designed to integrate rules to customized repositories and make rules persistent.</p>\n<p>For more details, you can refer to <a href=\"./dynamic-rule-configuration.md\">Dynamic Rule Configuration</a>.</p>\n",
  "link": "/en-us/docs/basic-api-resource-rule.html",
  "meta": {}
}