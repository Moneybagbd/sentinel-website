{
  "filename": "envoy-global-rate-limiting-support.md",
  "__html": "<h1>Envoy global rate limiting support</h1>\n<p>Sentinel provides the <code>sentinel-cluster-server-envoy-rls</code> module, enabling support for <a href=\"https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting#arch-overview-rate-limit\">Envoy rate limiting gRPC service</a>.</p>\n<div style=\"text-align: center;\">\n<img src=\"https://user-images.githubusercontent.com/9434884/68639837-d2266980-0540-11ea-8997-05084e2e47bb.png\" alt=\"Envoy RLS Sentinel overview\" style=\"width: 60%;\" />\n</div>\n<h2>Build</h2>\n<p>Build the executable jar:</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-built_in\">cd</span> sentinel-cluster-server-envoy-rls\nmvn clean package -P prod\n</code></pre>\n<h2>Rule configuration</h2>\n<p>Currently Sentinel RLS token server supports dynamic rule configuration via the yaml file.\nThe file may provide rules for one <em>domain</em> (defined in Envoy's conf file).\nIn Envoy, one rate limit request might carry multiple <em>rate limit descriptors</em>\n(which will be generated from <a href=\"https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-msg-config-route-v3-ratelimit\">Envoy rate limit actions</a>).\nOne rate limit descriptor may have multiple entries (key-value pair).\nWe may set different threshold for each rate limit descriptors.</p>\n<p>A sample rule configuration file:</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">domain:</span> <span class=\"hljs-string\">foo</span>\n<span class=\"hljs-attr\">descriptors:</span>\n<span class=\"hljs-attr\">  - resources:</span>\n<span class=\"hljs-attr\">    - key:</span> <span class=\"hljs-string\">\"destination_cluster\"</span>\n<span class=\"hljs-attr\">      value:</span> <span class=\"hljs-string\">\"service_httpbin\"</span>\n<span class=\"hljs-attr\">    count:</span> <span class=\"hljs-number\">1</span>\n</code></pre>\n<p>This rule only takes effect for domain <code>foo</code>. It will limit the max QPS to 1 for\nall requests targeted to the <code>service_httpbin</code> cluster.</p>\n<p>We need to provide the path to yaml file via the <code>SENTINEL_RLS_RULE_FILE_PATH</code> env\n(or <code>-Dcsp.sentinel.rls.rule.file</code> opts). Then as soon as the content in the rule file has been changed,\nSentinel will reload the new rules from the file to the <code>EnvoyRlsRuleManager</code>.</p>\n<p>We may check the logs in <code>~/logs/csp/sentinel-record.log.xxx</code> to see whether the rules has been loaded.\nWe may also retrieve the converted <code>FlowRule</code> via the command API <code>localhost:8719/cluster/server/flowRules</code>.</p>\n<h2>Configuration items</h2>\n<p>The configuration list:</p>\n<table>\n<thead>\n<tr>\n<th>Item (env)</th>\n<th>Item (JVM property)</th>\n<th>Description</th>\n<th>Default Value</th>\n<th>Required</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>SENTINEL_RLS_GRPC_PORT</code></td>\n<td><code>csp.sentinel.grpc.server.port</code></td>\n<td>The RLS gRPC server port</td>\n<td><strong>10240</strong></td>\n<td>false</td>\n</tr>\n<tr>\n<td><code>SENTINEL_RLS_RULE_FILE_PATH</code></td>\n<td><code>csp.sentinel.rls.rule.file</code></td>\n<td>The path of the RLS rule yaml file</td>\n<td>-</td>\n<td><strong>true</strong></td>\n</tr>\n<tr>\n<td><code>SENTINEL_RLS_ACCESS_LOG</code></td>\n<td>-</td>\n<td>Whether to enable the access log (<code>on</code> for enable)</td>\n<td>off</td>\n<td>false</td>\n</tr>\n</tbody>\n</table>\n<h2>Samples</h2>\n<ul>\n<li><a href=\"https://github.com/alibaba/Sentinel/tree/master/sentinel-cluster/sentinel-cluster-server-envoy-rls/sample/k8s\">Kubernetes sample</a></li>\n</ul>\n"
}