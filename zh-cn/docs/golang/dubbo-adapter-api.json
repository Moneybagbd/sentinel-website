{
  "filename": "dubbo-adapter-api.md",
  "__html": "<h1>在dubbo-go中使用sentinel</h1>\n<p>在sentinel-golang中已经实现了对dubbo-go的adapter代码，您可以很轻松的在dubbo-go中使用sentinel。</p>\n<p>注意：dubbo-go版本请使用1.3.0-rc3及其以上版本</p>\n<p>dubbo-go仓库地址：<a href=\"https://github.com/apache/dubbo-go\">https://github.com/apache/dubbo-go</a></p>\n<p>在dubbo-go中使用sentinel主要分为以下几步：</p>\n<p>1.初始化sentinel</p>\n<p>2.将sentinel注入dubbo-go的filter</p>\n<p>3.初始化dubbo-go</p>\n<p>4.配置规划</p>\n<h2>初始化sentinel</h2>\n<p>示例代码：</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">import</span> (\n\tsentinel <span class=\"hljs-string\">\"github.com/alibaba/sentinel-golang/api\"</span>\n)\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">initSentinel</span><span class=\"hljs-params\">()</span></span> {\n\terr := sentinel.InitWithLogDir(confPath, logDir)\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t<span class=\"hljs-comment\">// 初始化 Sentinel 失败</span>\n\t}\n}\n</code></pre>\n<h2>将sentinel注入dubbo-go的filter</h2>\n<p>你可以通过import包的形式执行，执行其中的init()来注入filter</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">import</span> (\n\t_ <span class=\"hljs-string\">\"github.com/alibaba/sentinel-golang/adapter/dubbo\"</span>\n)\n\n</code></pre>\n<p>也可以手动执行，给你的filter取上自己想要的名字</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">import</span> (\n  <span class=\"hljs-string\">\"github.com/apache/dubbo-go/common/extension\"</span>\n  sd <span class=\"hljs-string\">\"github.com/alibaba/sentinel-golang/adapter/dubbo\"</span>\n)\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span></span>{\n  extension.SetFilter(<span class=\"hljs-string\">\"myConsumerFilter\"</span>,sd.GetConsumerFilter())\n  extension.SetFilter(<span class=\"hljs-string\">\"myProviderFilter\"</span>,sd.GetConsumerFilter())\n}\n</code></pre>\n<p>完成以上步骤，你就可以在需要的dubbo接口配置里写入sentinel的filterName,构建起接口的filter链条。比如以下以consumer.yml配置文件为例</p>\n<pre><code class=\"language-yml\"><span class=\"hljs-attr\">references:</span>\n<span class=\"hljs-attr\">  \"UserProvider\":</span>\n<span class=\"hljs-attr\">    registry:</span> <span class=\"hljs-string\">\"hangzhouzk\"</span>\n    <span class=\"hljs-string\">protocol</span> <span class=\"hljs-string\">:</span> <span class=\"hljs-string\">\"dubbo\"</span>\n    <span class=\"hljs-string\">interface</span> <span class=\"hljs-string\">:</span> <span class=\"hljs-string\">\"com.ikurento.user.UserProvider\"</span>\n<span class=\"hljs-attr\">    cluster:</span> <span class=\"hljs-string\">\"failover\"</span>\n<span class=\"hljs-attr\">    filter:</span> <span class=\"hljs-string\">\"myConsumerFilter\"</span>\n    <span class=\"hljs-string\">methods</span> <span class=\"hljs-string\">:</span>\n<span class=\"hljs-attr\">    - name:</span> <span class=\"hljs-string\">\"GetUser\"</span>\n<span class=\"hljs-attr\">      retries:</span> <span class=\"hljs-number\">3</span>\n</code></pre>\n<h2>初始化dubbo-go</h2>\n<p>到这一步，你只需要正常启动dubbo-go程序就完成了服务启动。用以下代码做一个较为完整举例</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">import</span> (\n\thessian <span class=\"hljs-string\">\"github.com/apache/dubbo-go-hessian2\"</span>\n\tsd <span class=\"hljs-string\">\"github.com/alibaba/sentinel-golang/adapter/dubbo\"</span>\n)\n\n<span class=\"hljs-keyword\">import</span> (\n\t<span class=\"hljs-string\">\"github.com/apache/dubbo-go/common/logger\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/common/proxy/proxy_factory\"</span>\n\t<span class=\"hljs-string\">\"github.com/apache/dubbo-go/config\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/filter/impl\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/protocol/dubbo\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/registry/protocol\"</span>\n\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/cluster/cluster_impl\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/cluster/loadbalance\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/registry/zookeeper\"</span>\n\t<span class=\"hljs-string\">\"github.com/apache/dubbo-go/common/extension\"</span>\n)\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span></span> {\n\n\thessian.RegisterPOJO(&amp;User{})\n  extension.SetFilter(<span class=\"hljs-string\">\"myConsumerFilter\"</span>,sd.GetConsumerFilter())\n  extension.SetFilter(<span class=\"hljs-string\">\"myProviderFilter\"</span>,sd.GetConsumerFilter())\n\tconfig.Load()\n\n\t<span class=\"hljs-comment\">// init finish, do your work</span>\n\ttest()\n\n}\n</code></pre>\n<h2>规划配置</h2>\n<p>sentinel以强大的规划配置吸引了很多使用者，其提供动态数据源接口进行扩展，用户可以通过动态文件或 etcd 等配置中心来动态地配置规则。但目前sentinel-golang作为破蛋版本，动态配置还在开发中</p>\n<h3>动态数据源</h3>\n<p>（规划中）Sentinel 提供动态数据源接口进行扩展，用户可以通过动态文件或 etcd 等配置中心来动态地配置规则。</p>\n<h3>硬编码方式</h3>\n<p>Sentinel 也支持原始的硬编码方式加载规则，可以通过各个模块的 <code>LoadRules(rules)</code> 方法加载规则。以下是硬编码方式对某个method在consumer端的QPS流控：</p>\n<pre><code class=\"language-go\">_, err := flow.LoadRules([]*flow.FlowRule{\n\t{\n\t\tID:                <span class=\"hljs-number\">666</span>,\n\t\tResource:         <span class=\"hljs-string\">\"dubbo:consumer:com.ikurento.user.UserProvider:myGroup:1.0.0:hello()\"</span>,\n\t\tMetricType:        flow.QPS,\n\t\tCount:             <span class=\"hljs-number\">10</span>,\n\t\tControlBehavior:   flow.Reject,\n\t},\n})\n<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t<span class=\"hljs-comment\">// 加载规则失败，进行相关处理</span>\n}\n</code></pre>\n"
}